@model ResearchViewModel


<h2>Research</h2>

<table id="researchTable" class="display">
    <thead>
        <tr>
            <th>Research Name</th>
            <th>Requirements</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
      
            
            @foreach(var item in Model.Research)
            {
                <tr>
                    <td>@item.Name</td>
                    <td>
                    @foreach(var ii in item.Requirements){

                                var invItem = Model.InventoryItem.FirstOrDefault(x => x.ItemId == ii.ItemId);
                                var currentQty = invItem?.Quantity ?? 0;  // if null, quantity = 0

                        <p>
                            @ii.Item.Name (<span class="inv-qty"
                                                 data-itemid="@ii.ItemId">@currentQty</span> / @ii.Quantity)
                        </p>
                    }
                        </td>
                        <td>
                    <button class="btn btn-sm btn-success research-btn"
                            data-researchid="@item.Id"
                            data-duration="@item.Duration.TotalSeconds">
                        Research
                    </button>
                        </td>
                </tr>
            }

        
    </tbody>
</table>
@section Scripts {
    <script>
        $(document).ready(function () {
            $('#researchTable').DataTable();
        });

                $(".research-btn").click(function () {
            var button = $(this);
            var researchId = button.data("researchid");
          //  var duration = parseInt(button.data("duration"));

            $.ajax({
                url: '/Research/StartResearch',
                type: 'POST',
                data: { researchId: researchId },
                success: function (response) {
                    if (response.success) {
                          // ✅ deduct inventory quantities in UI
                if (response.deductions) {
                    response.deductions.forEach(function (d) {
                        // Find the span with this itemId
                        var span = $('span.inv-qty[data-itemid="' + d.itemId + '"]');
                        var current = parseInt(span.text());
                        span.text(current - d.used); // update UI
                    });
                }

                 toastr.success("Started research: " + response.researchName);

                        // ✅ start countdown
                        var remaining = response.duration;
                        var originalText = "Research";
                          button.prop("disabled", true)
        .removeClass("btn-success")
        .addClass("btn-secondary");

                        button.text(remaining + "s");

                        var timer = setInterval(function () {
                            remaining--;
                            button.text(remaining + "s");

                            if (remaining <= 0) {
                                clearInterval(timer);
                                button.prop("disabled", false)
                                      .text(originalText)
                                      .removeClass("btn-secondary")
                                      .addClass("btn-success");
                                      toastr.success("Research '" + response.researchName + "' completed!");
                            }
                        }, 1000);

                    } else {
                        // ❌ show toastr error
                        toastr.error(response.message);
                    }
                }
            });
        });

    </script>

}
